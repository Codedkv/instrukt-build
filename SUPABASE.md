# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Supabase Ð´Ð»Ñ PerplexitySchool

## ÐžÐ±Ð·Ð¾Ñ€

Ð”Ð°Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Supabase Ð´Ð»Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑƒÑ€Ð¾ÐºÐ°Ð¼Ð¸ PerplexitySchool.

---

## ðŸ“Š Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†

### 1. Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `lessons` (Ð£Ñ€Ð¾ÐºÐ¸)

ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾Ð± ÑƒÑ€Ð¾ÐºÐ°Ñ….

**ÐšÐ¾Ð»Ð¾Ð½ÐºÐ¸:**
- `id` (UUID, PRIMARY KEY) - Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ ÑƒÑ€Ð¾ÐºÐ°
- `uuid` (UUID, NOT NULL) - Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ UUID
- `title` (TEXT, NOT NULL) - ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÑƒÑ€Ð¾ÐºÐ°
- `description` (TEXT, NULL) - ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑƒÑ€Ð¾ÐºÐ°
- `content` (TEXT, NULL) - ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÑƒÑ€Ð¾ÐºÐ°
- `video_url` (TEXT, NULL) - URL Ð²Ð¸Ð´ÐµÐ¾ ÑƒÑ€Ð¾ÐºÐ°
- `order_index` (INTEGER, NOT NULL, DEFAULT 0) - **ÐŸÐ¾Ñ€ÑÐ´ÐºÐ¾Ð²Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ð´Ð»Ñ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸ ÑƒÑ€Ð¾ÐºÐ¾Ð²**
- `status` (TEXT, NOT NULL, DEFAULT 'draft') - **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑƒÑ€Ð¾ÐºÐ°: 'draft', 'published', 'archived'**
- `duration_minutes` (INTEGER, NULL) - Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÑƒÑ€Ð¾ÐºÐ° Ð² Ð¼Ð¸Ð½ÑƒÑ‚Ð°Ñ…
- `thumbnail_url` (TEXT, NULL) - URL Ð¼Ð¸Ð½Ð¸Ð°Ñ‚ÑŽÑ€Ñ‹ ÑƒÑ€Ð¾ÐºÐ°
- `publish_date` (TIMESTAMPTZ, NULL) - Ð”Ð°Ñ‚Ð° Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸
- `is_published` (BOOLEAN, NULL, DEFAULT false) - Ð¤Ð»Ð°Ð³ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ (ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐµÐµ Ð¿Ð¾Ð»Ðµ)
- `created_at` (TIMESTAMPTZ, NULL, DEFAULT NOW()) - Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ
- `updated_at` (TIMESTAMPTZ, NULL, DEFAULT NOW()) - Ð”Ð°Ñ‚Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ

**Ð˜Ð½Ð´ÐµÐºÑÑ‹:**
- `lessons_pkey` - PRIMARY KEY (id)
- `lessons_order_index_key` - UNIQUE (order_index)
- `idx_lessons_order` - INDEX (order_index)
- `idx_lessons_status` - INDEX (status)
- `idx_lessons_published` - INDEX (is_published) WHERE is_published = true

**Constraints:**
- `lessons_status_check` - CHECK (status IN ('draft', 'published', 'archived'))

---

### 2. Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `lesson_content` (ÐšÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ ÑƒÑ€Ð¾ÐºÐ¾Ð²)

**ÐÐžÐ’ÐÐ¯ Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð** Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ‚Ð¸Ð¿Ð¾Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÑƒÑ€Ð¾ÐºÐ° (Ð²Ð¸Ð´ÐµÐ¾, Ñ‚ÐµÐºÑÑ‚, Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ, Ñ„Ð°Ð¹Ð»Ñ‹).

**ÐšÐ¾Ð»Ð¾Ð½ÐºÐ¸:**
- `id` (UUID, PRIMARY KEY, DEFAULT gen_random_uuid()) - Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°
- `lesson_id` (UUID, NOT NULL, REFERENCES lessons(id) ON DELETE CASCADE) - **Ð¡Ð²ÑÐ·ÑŒ Ñ ÑƒÑ€Ð¾ÐºÐ¾Ð¼**
- `content_type` (TEXT, NOT NULL) - **Ð¢Ð¸Ð¿ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°: 'video', 'text', 'image', 'file'**
- `content_data` (JSONB, NOT NULL) - **Ð”Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ JSON**
  - Ð”Ð»Ñ Ð²Ð¸Ð´ÐµÐ¾: `{"url": "...", "title": "...", "description": "..."}`
  - Ð”Ð»Ñ Ñ‚ÐµÐºÑÑ‚Ð°: `{"text": "...", "formatting": "..."}`
  - Ð”Ð»Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ: `{"url": "...", "alt": "...", "caption": "..."}`
  - Ð”Ð»Ñ Ñ„Ð°Ð¹Ð»Ð°: `{"url": "...", "filename": "...", "size": "..."}`
- `order_index` (INTEGER, NOT NULL, DEFAULT 0) - **ÐŸÐ¾Ñ€ÑÐ´ÐºÐ¾Ð²Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÑƒÑ€Ð¾ÐºÐ°**
- `created_at` (TIMESTAMPTZ, DEFAULT NOW()) - Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ
- `updated_at` (TIMESTAMPTZ, DEFAULT NOW()) - Ð”Ð°Ñ‚Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ

**Ð˜Ð½Ð´ÐµÐºÑÑ‹:**
- `lesson_content_pkey` - PRIMARY KEY (id)
- `idx_lesson_content_lesson` - INDEX (lesson_id, order_index)

**Constraints:**
- `lesson_content_content_type_check` - CHECK (content_type IN ('video', 'text', 'image', 'file'))
- `lesson_content_lesson_id_fkey` - FOREIGN KEY (lesson_id) REFERENCES lessons(id) ON DELETE CASCADE

---

### 3. Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `progress` (ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹)

Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð¿Ð¾ ÑƒÑ€Ð¾ÐºÐ°Ð¼.

**ÐšÐ¾Ð»Ð¾Ð½ÐºÐ¸:**
- `id` (UUID, PRIMARY KEY) - Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°
- `user_id` (UUID, NOT NULL) - ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (ÑÐ²ÑÐ·ÑŒ Ñ auth.users)
- `lesson_id` (UUID, NOT NULL) - ID ÑƒÑ€Ð¾ÐºÐ° (ÑÐ²ÑÐ·ÑŒ Ñ lessons)
- `completed` (BOOLEAN, NOT NULL, DEFAULT FALSE) - **Ð¤Ð»Ð°Ð³ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ ÑƒÑ€Ð¾ÐºÐ°**
- `last_accessed` (TIMESTAMPTZ, DEFAULT NOW()) - **Ð”Ð°Ñ‚Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÑƒÑ€Ð¾ÐºÑƒ**
- `completion_date` (TIMESTAMPTZ, NULL) - **Ð”Ð°Ñ‚Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ ÑƒÑ€Ð¾ÐºÐ°**
- `progress_percentage` (INTEGER, DEFAULT 0) - ÐŸÑ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð¿Ñ€Ð¾Ñ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ ÑƒÑ€Ð¾ÐºÐ° (0-100)
- `created_at` (TIMESTAMPTZ, DEFAULT NOW()) - Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸
- `updated_at` (TIMESTAMPTZ, DEFAULT NOW()) - Ð”Ð°Ñ‚Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ

**Ð˜Ð½Ð´ÐµÐºÑÑ‹:**
- `progress_pkey` - PRIMARY KEY (id)
- `idx_progress_user_lesson` - **UNIQUE INDEX (user_id, lesson_id)** - ÐžÐ´Ð¸Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¸Ð¼ÐµÑ‚ÑŒ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°
- `idx_progress_user` - INDEX (user_id)

**Constraints:**
- `progress_percentage_check` - CHECK (progress_percentage >= 0 AND progress_percentage <= 100)

---

## ðŸ”’ Row Level Security (RLS)

### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `lessons`

**Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾:** âœ… `ALTER TABLE public.lessons ENABLE ROW LEVEL SECURITY;`

**ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸:**

1. **"Admins can do everything with lessons"** (FOR ALL)
   - ÐÐ´Ð¼Ð¸Ð½Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ, Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ, Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ð¸ ÑƒÐ´Ð°Ð»ÑÑ‚ÑŒ Ð²ÑÐµ ÑƒÑ€Ð¾ÐºÐ¸
   - Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¸Ð¼ÐµÐµÑ‚ Ñ€Ð¾Ð»ÑŒ 'admin' Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ user_roles

2. **"Users can view published lessons"** (FOR SELECT)
   - ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑƒÑ€Ð¾ÐºÐ¸
   - Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: `status = 'published'` AND `auth.uid() IS NOT NULL`

---

### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `lesson_content`

**Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾:** âœ… `ALTER TABLE public.lesson_content ENABLE ROW LEVEL SECURITY;`

**ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸:**

1. **"Admins can do everything with lesson_content"** (FOR ALL)
   - ÐÐ´Ð¼Ð¸Ð½Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð²ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð¾Ð¼ ÑƒÑ€Ð¾ÐºÐ¾Ð²
   - Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¸Ð¼ÐµÐµÑ‚ Ñ€Ð¾Ð»ÑŒ 'admin' Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ user_roles

2. **"Users can view content of published lessons"** (FOR SELECT)
   - ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²Ð¸Ð´ÐµÑ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ñ… ÑƒÑ€Ð¾ÐºÐ¾Ð²
   - Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: ÑƒÑ€Ð¾Ðº Ð¸Ð¼ÐµÐµÑ‚ ÑÑ‚Ð°Ñ‚ÑƒÑ 'published' AND Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½

---

### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `progress`

**Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾:** âœ… `ALTER TABLE public.progress ENABLE ROW LEVEL SECURITY;`

**ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸:**

1. **"Users can view their own progress"** (FOR SELECT)
   - ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ
   - Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: `auth.uid() = user_id`

2. **"Users can insert their own progress"** (FOR INSERT)
   - ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ ÑÐµÐ±Ñ
   - Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: `auth.uid() = user_id`

3. **"Users can update their own progress"** (FOR UPDATE)
   - ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ
   - Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: `auth.uid() = user_id`

4. **"Admins can view all progress"** (FOR SELECT)
   - ÐÐ´Ð¼Ð¸Ð½Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ Ð²ÑÐµÑ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
   - Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¸Ð¼ÐµÐµÑ‚ Ñ€Ð¾Ð»ÑŒ 'admin' Ð² Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ user_roles

---

## âš™ï¸ Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹

### ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ `updated_at`

**Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ:**
```sql
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹:**
1. `set_updated_at_lessons` - ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¸ UPDATE Ð½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ lessons
2. `set_updated_at_lesson_content` - ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¸ UPDATE Ð½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ lesson_content
3. `set_updated_at_progress` - ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¸ UPDATE Ð½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ progress

---

## ðŸ“ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸

### 1. `get_user_progress_percentage(p_user_id UUID)`

**ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ:** Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÑ‚ Ð¾Ð±Ñ‰Ð¸Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½Ð½Ñ‹Ñ… ÑƒÑ€Ð¾ÐºÐ¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (Ð´Ð»Ñ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð° Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°).

**Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚:** INTEGER (0-100)

**Ð›Ð¾Ð³Ð¸ÐºÐ°:**
1. Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ Ð¾Ð±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ñ… ÑƒÑ€Ð¾ÐºÐ¾Ð²
2. Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½Ð½Ñ‹Ñ… ÑƒÑ€Ð¾ÐºÐ¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ (completed = TRUE)
3. Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚: `(completed / total) * 100`

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ:**
```sql
SELECT get_user_progress_percentage(auth.uid());
```

---

### 2. `upsert_lesson_progress(p_user_id UUID, p_lesson_id UUID, p_completed BOOLEAN DEFAULT FALSE)`

**ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ:** Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿Ð¾ ÑƒÑ€Ð¾ÐºÑƒ.

**Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚:** UUID (ID Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°)

**Ð›Ð¾Ð³Ð¸ÐºÐ°:**
1. ÐŸÑ‹Ñ‚Ð°ÐµÑ‚ÑÑ Ð²ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°
2. ÐŸÑ€Ð¸ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ðµ (user_id, lesson_id ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚) Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ Ð·Ð°Ð¿Ð¸ÑÑŒ:
   - ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ `last_accessed` Ð½Ð° Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ
   - Ð•ÑÐ»Ð¸ `p_completed = TRUE`, ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ `completed = TRUE`
   - Ð•ÑÐ»Ð¸ ÑƒÑ€Ð¾Ðº Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½, ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ `completion_date`

**ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ:**
```sql
-- ÐžÑ‚Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÑƒÑ€Ð¾ÐºÑƒ
SELECT upsert_lesson_progress(auth.uid(), 'lesson-uuid', FALSE);

-- Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑƒÑ€Ð¾Ðº
SELECT upsert_lesson_progress(auth.uid(), 'lesson-uuid', TRUE);
```

---

## ðŸŽ¯ ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸

### Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
âœ… Ð’ÑÐµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ñ‹ Row Level Security (RLS)
âœ… ÐÐ´Ð¼Ð¸Ð½Ñ‹ Ð¸Ð¼ÐµÑŽÑ‚ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ ÐºÐ¾ Ð²ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ð¼
âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑƒÑ€Ð¾ÐºÐ¸
âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÑÑŽÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸Ð¼ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ¾Ð¼
âœ… Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð½Ð´ÐµÐºÑ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð´ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°

### ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
âœ… Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð½Ð° Ñ‡Ð°ÑÑ‚Ð¾ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ Ð¿Ð¾Ð»Ñ (order_index, status, user_id)
âœ… Ð¡Ð¾ÑÑ‚Ð°Ð²Ð½Ð¾Ð¹ Ð¸Ð½Ð´ÐµÐºÑ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° ÑƒÑ€Ð¾ÐºÐ°
âœ… ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÐºÐ°ÑÐºÐ°Ð´Ð½Ð¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ ÑƒÑ€Ð¾ÐºÐ°

### Ð“Ð¸Ð±ÐºÐ¾ÑÑ‚ÑŒ
âœ… JSONB Ð´Ð»Ñ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ‚Ð¸Ð¿Ð¾Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°
âœ… ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð° Ð² Ð¾Ð´Ð½Ð¾Ð¼ ÑƒÑ€Ð¾ÐºÐµ
âœ… Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¿Ð¾Ñ€ÑÐ´ÐºÐ° ÑƒÑ€Ð¾ÐºÐ¾Ð² Ð¸ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð°
âœ… Ð¡Ñ‚Ð°Ñ‚ÑƒÑÑ‹ ÑƒÑ€Ð¾ÐºÐ¾Ð² Ð´Ð»Ñ Ñ‡ÐµÑ€Ð½Ð¾Ð²Ð¸ÐºÐ¾Ð² Ð¸ Ð°Ñ€Ñ…Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

---

## ðŸ“‹ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¸

### Ð”Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð²
1. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ/Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑ€Ð¾ÐºÐ¾Ð² Ñ‡ÐµÑ€ÐµÐ· ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ `/admin/lessons`
2. Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚Ð¾Ð¼ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÑƒÑ€Ð¾ÐºÐ¾Ð² (Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð²Ð¸Ð´ÐµÐ¾, Ñ‚ÐµÐºÑÑ‚Ð°, Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹)
3. Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ñ€ÑÐ´ÐºÐ° ÑƒÑ€Ð¾ÐºÐ¾Ð² (drag-and-drop)
4. ÐŸÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ/Ð°Ñ€Ñ…Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑƒÑ€Ð¾ÐºÐ¾Ð²
5. ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¿Ð¾ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÑƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹

### Ð”Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
1. ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð½Ñ‹Ñ… ÑƒÑ€Ð¾ÐºÐ¾Ð² Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ `/lessons`
2. ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°
3. ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð° Ð¾Ð±Ñ‰ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ° Ð² Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ðµ
4. Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ ÑƒÑ€Ð¾Ðº Ð¸ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ðº ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼Ñƒ

---

## ðŸš€ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…

Ð’ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹ Ñ‡ÐµÑ€ÐµÐ· SQL-ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð² Supabase SQL Editor.

**Ð”Ð°Ñ‚Ð° Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸:** 25 Ð¾ÐºÑ‚ÑÐ±Ñ€Ñ 2025

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¾

---

## ðŸ“ž ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹

**ÐŸÑ€Ð¾ÐµÐºÑ‚:** PerplexitySchool  
**Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…:** Supabase  
**Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº:** Codedkv
